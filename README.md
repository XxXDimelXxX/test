# Balance Service (Test Assignment)

Небольшой web-server для управления балансом пользователя с поддержкой истории операций.

Проект реализует атомарное списание средств с учётом конкурентного доступа, идемпотентности запросов и точных денежных расчётов.

---

## Стек

- Node.js
- NestJS
- TypeScript
- PostgreSQL
- TypeORM

**Все денежные значения хранятся и считаются в целых числах (центах / копейках).**

---

## Общая идея

В системе используется **ledger-подход**:

- Все изменения баланса записываются в таблицу `transactions`
- Таблица `users` хранит **агрегированное состояние** баланса
- Источник истины — журнал транзакций (`transactions`)
- Баланс пользователя пересчитывается как сумма всех транзакций

---

### Выбор в этом проекте

В рамках данного задания выбран **полный пересчёт баланса**,  
так как приоритетом являются **корректность и прозрачность логики**.

При переходе к high-load сценарию:
- баланс должен обновляться инкрементально
- полный пересчёт может быть вынесен в background-задачи или reconciliation-процессы

---

## Структура данных

### users

| Поле        | Тип           | Описание                         |
|-------------|---------------|----------------------------------|
| id          | INT           | Идентификатор пользователя       |
| balance     | BIGINT        | Агрегированный баланс (в центах) |
| updated_at  | TIMESTAMPTZ   | Время обновления                 |

---

### transactions (ledger)

| Поле    | Тип         | Описание                                  |
|---------|-------------|-------------------------------------------|
| id      | UUID        | Idempotency Key (генерируется фронтендом) |
| user_id | INT         | Владелец транзакции                       |
| amount  | BIGINT      | Сумма операции (signed, в центах)         |
| ts      | TIMESTAMPTZ | Время операции                            |

---

В базе данных заранее существует пользователь с `id = 1`.

Необходимо реализовать списание баланса пользователя.  
Например: пользователь покупает товар за $100 — баланс уменьшается, операция сохраняется в истории.

Баланс пользователя хранится и обновляется после каждой операции, история используется как ledger.

---

## Ключевые гарантии решения

### Атомарность
Добавление транзакции и пересчёт баланса выполняются **в одной DB-транзакции**.


### Защита от гонок
Для пользователя применяется блокировка строки:
Это гарантирует корректный баланс при параллельных запросах.


### Идемпотентность
- `transactions.id` — это **Idempotency Key (IK)**
- Повторный запрос с тем же `id`:
  - не создаёт новую транзакцию
  - не меняет баланс
  - возвращает `idempotent: true`


### Защита от отрицательного баланса
Если после пересчёта баланс становится `< 0`:
- транзакция откатывается
- возвращается ошибка `Insufficient funds`


---

## Запуск проекта

```
npm install
npm run start:dev
```

---

# API

## Получить баланс пользователя

### GET /users/:userId

### Res:
```
{
  "id": 1,
  "balance": "20050" // 200.50 на фронте
}
```

---

## Добавить транзакцию (пополнение или списание)

### POST /users/:userId/transactions

#### Body:

```
{
  "id": "8d3b2f7a-5b8c-4b68-9e8e-2b05a6c0d1c1",
  "amount": -10025
}
```

### Res:
```
{
  "ok": true,
  "userId": 1,
  "idempotent": false,
  "balance": "10025",
  "transactionId": "8d3b2f7a-5b8c-4b68-9e8e-2b05a6c0d1c1"
}
```
