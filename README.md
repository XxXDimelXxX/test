# Balance Service (Test Assignment)

Небольшой web-server для управления балансом пользователя с поддержкой истории операций.

Проект реализует атомарное списание средств с учётом конкурентного доступа, идемпотентности запросов и точных денежных расчётов.

---

## Стек

- Node.js
- NestJS
- TypeScript
- PostgreSQL
- TypeORM
- Все денежные значения хранятся и считаются в **центах/копейках** (целые числа)

---

## Описание задачи

В системе есть:

- таблица `users` с полями:
    - `id`
    - `balance`
- таблица `transactions` (ledger):
    - `id` (UUID, генерируется фронтендом — IK)
    - `user_id`
    - `amount` (signed, bigint, в центах)
    - `ts`

В базе данных заранее существует пользователь с `id = 1`.

Необходимо реализовать списание баланса пользователя.  
Например: пользователь покупает товар за $100 — баланс уменьшается, операция сохраняется в истории.

Баланс пользователя хранится и обновляется после каждой операции, история используется как ledger.

---

## Ключевые гарантии решения

- Атомарность операций  
  Списание средств и запись истории выполняются в одной транзакции.

- Защита от гонок  
  Используется `SELECT ... FOR UPDATE` для блокировки строки пользователя.

- Идемпотентность  
  Повторный запрос с тем же `id` (IK) не приводит к повторному добавлению транзакции.

- Точные денежные расчёты  
  Все суммы — целые числа (цента/копейки). Фронтенд может переводить значение в «рубли/доллары» простым делением/умножением на 100.

---

## Почему баланс пересчитывается через ledger

В данной версии баланс пользователя **пересчитывается как `SUM(transactions.amount)`** при каждой новой транзакции.

Это упрощает логику и гарантирует корректность агрегата при любом наборе операций.

### Ledger как источник истины, баланс как агрегат

Таблица `transactions` является журналом операций (ledger),
а поле `users.balance` — агрегированным состоянием этого журнала.

При каждой операции:
1. Добавляется запись в `transactions` (если `id` ещё не был использован)
2. Баланс пользователя пересчитывается как `SUM(transactions.amount)`

---

---

## Запуск проекта

```
npm install
npm run start:dev
```

## Схема базы данных (упрощённо)

```sql
users (
  id INT PRIMARY KEY,
  balance BIGINT, -- в центах
  updated_at TIMESTAMPTZ
)

transactions (
  id UUID PRIMARY KEY, -- IK генерирует фронтенд
  user_id INT REFERENCES users(id),
  amount BIGINT, -- signed, в центах
  ts TIMESTAMPTZ
)
```

---

# API

## Получить баланс пользователя

### GET /users/:userId

### Res:
```
{
  "id": 1,
  "balance": "20050" // 200.50 на фронте
}
```

---

## Добавить транзакцию (пополнение или списание)

### POST /users/:userId/transactions

#### Body:

```
{
  "id": "8d3b2f7a-5b8c-4b68-9e8e-2b05a6c0d1c1",
  "amount": -10025
}
```

### Res:
```
{
  "ok": true,
  "userId": 1,
  "idempotent": false,
  "balance": "10025",
  "transactionId": "8d3b2f7a-5b8c-4b68-9e8e-2b05a6c0d1c1"
}
```
